<!DOCTYPE html>
<html>
  <head>
    <title>com.mitchmckean.mccontrol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="sdpi.css" />
  </head>

  <body>
    <script>
      var websocket = null;
      var pluginUUID = null;

      var DestinationEnum = Object.freeze({ HARDWARE_AND_SOFTWARE: 0, HARDWARE_ONLY: 1, SOFTWARE_ONLY: 2 });
      var settinggCache = {};
      var mcControlActions = {
        type: "com.elgato.counter.action",

        onKeyDown: function (context, settings, coordinates, userDesiredState) {
          console.log(settings);
          console.log("found link: " + settings.apiLink);
          console.log("found item: " + settings.itemName);
        },

        onKeyUp: function (context, settings, coordinates, userDesiredState) {
          //clearTimeout(timer);
          // console.log(settings);
          // var openHabItem = jsonPayload["apiLink"] + jsonPayload["itemName"];
          // var keyDisplayValue = "OFF";
          // if (settings != null && settings.hasOwnProperty("keyDisplayValue")) {
          //   keyDisplayValue = settings["keyDisplayValue"];
          // }
          // var command = "ON";
          // if (keyDisplayValue === "ON") {
          //   command = "OFF";
          // }
          // var keyDisplayValue = command;
          // fetch(openHabItem, {
          //   method: "post",
          //   headers: { "Content-Type": "text/plain" },
          //   body: command,
          // });
          // updatedSettings = {};
          // updatedSettings["keyDisplayValue"] = keyDisplayValue;
          // this.SetSettings(context, updatedSettings);
          // this.SetTitle(context, keyDisplayValue);
        },

        onWillAppear: function (context, settings, coordinates) {
          var initConfig = {
            apiLink: "http://192.168.151.111:8080/rest/items/",
            itemName: "",
          };

          this.SetSettings(context, initConfig);
          settinggCache = initConfig;

          // if (settings == null) {
          //   this.SetSettings(context, initConfig);
          // } else {
          //   console.log("settings already found");
          //   console.log(settings);
          // }

          // var openHabItem = jsonPayload["apiLink"] + jsonPayload["itemName"];
          // var keyDisplayValue = "OFF";
          // if (settings != null && settings.hasOwnProperty("keyDisplayValue")) {
          //   keyDisplayValue = settings["keyDisplayValue"];
          // }
          // if (jsonPayload["itemName"] != null) {
          //   fetch(openHabItem, {
          //     method: "get",
          //   })
          //     .then((response) => {
          //       return response.json();
          //     })
          //     .then((data) => {
          //       var got = data;
          //       if (got.state === "ON") {
          //         keyDisplayValue = "ON";
          //       }
          //       if (got.state === "OFF" || got.state === "NULL") {
          //         keyDisplayValue = "OFF";
          //       }
          //     })
          //     .then(() => {
          //       console.log("set keyDisplayValue to: " + keyDisplayValue);
          //       this.SetTitle(context, keyDisplayValue);
          //     });
          // }
        },
        onSetSettings: function (context, jsonPayload) {
          var newSettings = {};
          if (jsonPayload.itemName != undefined) {
            newSettings.itemName = jsonPayload.itemName;
            newSettings.apiLink = settinggCache.apiLink;
            settinggCache.itemName = jsonPayload.itemName;
            this.SetSettings(context, newSettings);
          }
          if (jsonPayload.apiLink != undefined) {
            newSettings.itemName = settinggCache.itemName;
            newSettings.apiLink = jsonPayload.apiLink;
            settinggCache.apiLink = jsonPayload.apiLink;
            this.SetSettings(context, newSettings);
          }

          // var openHabItem = settings["apiLink"] + settings["itemName"];
          // fetch(this.ohn, {
          //   method: "get",
          // })
          //   .then((response) => {
          //     return response.json();
          //   })
          //   .then((data) => {
          //     var got = data;
          //     var keyDisplayValue = got.state;
          //     updatedSettings = {};
          //     updatedSettings["apiLink"] = settings["apiLink"];
          //     updatedSettings["itemName"] = settings["itemName"];
          //     this.SetSettings(context, updatedSettings);
          //     this.SetTitle(context, keyDisplayValue);
          //   });
        },

        SetTitle: function (context, keyDisplayValue) {
          var json = {
            event: "setTitle",
            context: context,
            payload: {
              title: "" + keyDisplayValue,
              target: DestinationEnum.HARDWARE_AND_SOFTWARE,
            },
          };

          websocket.send(JSON.stringify(json));
        },

        SetSettings: function (context, settings) {
          var json = {
            event: "setSettings",
            context: context,
            payload: settings,
          };

          websocket.send(JSON.stringify(json));
        },
      };

      function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID;

        // Open the web socket
        websocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
          var json = {
            event: inRegisterEvent,
            uuid: inPluginUUID,
          };

          websocket.send(JSON.stringify(json));
        }

        websocket.onopen = function () {
          registerPlugin(pluginUUID);
        };

        websocket.onmessage = function (evt) {
          // Received message from Stream Deck
          var jsonObj = JSON.parse(evt.data);
          var event = jsonObj["event"];
          var action = jsonObj["action"];
          var context = jsonObj["context"];

          if (event == "keyDown") {
            console.log(jsonObj);
            var jsonPayload = jsonObj["payload"];
            var settings = jsonPayload["settings"];
            var coordinates = jsonPayload["coordinates"];
            var userDesiredState = jsonPayload["userDesiredState"];
            mcControlActions.onKeyDown(context, settings, coordinates, userDesiredState);
          } else if (event == "keyUp") {
            var jsonPayload = jsonObj["payload"];
            var settings = jsonPayload["settings"];
            var coordinates = jsonPayload["coordinates"];
            var userDesiredState = jsonPayload["userDesiredState"];
            mcControlActions.onKeyUp(context, settings, coordinates, userDesiredState);
          } else if (event == "willAppear") {
            var jsonPayload = jsonObj["payload"];
            var settings = jsonPayload["settings"];
            var coordinates = jsonPayload["coordinates"];
            mcControlActions.onWillAppear(context, settings, coordinates);
          } else if (event == "sendToPlugin") {
            var jsonPayload = jsonObj["payload"];
            mcControlActions.onSetSettings(context, jsonPayload);
          }
        };

        websocket.onclose = function () {};
      }
    </script>
  </body>
</html>
